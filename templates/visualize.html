<!doctype html>
<title>{{ title }}</title>
<script type="text/javascript"
        src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script type="text/javascript">
    var $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
</script>
<body>
    <script type="text/javascript">
        {# 0/F - waiting for init, 1/T - waiting for update #}
        var initiated = 0;
        var engaged = 0;

        function getCertaintyColor(certainty) {
            let fullHighlight;
            let defaultColor;
            if (certainty < 0) {
                return [80, 80, 80, 1.0];
            }
            const highlighted = [];
            if (certainty <= 0.5) {
                defaultColor = "{{ startColor }}".split(",");
                fullHighlight = "{{ midColor }}".split(",");
                certainty = certainty * 2;
            } else {
                defaultColor = "{{ midColor }}".split(",");
                fullHighlight = "{{ endColor }}".split(",");
                certainty = (certainty - 0.5) * 2;
            }
            for (var i=0;i<3;i++) {
                const defaultColorI = parseInt(defaultColor[i]);
                const fullHighlightI = parseInt(fullHighlight[i]);
                if (defaultColorI > fullHighlightI) {
                    highlighted.push(Math.round(defaultColorI - (defaultColorI - fullHighlightI) * certainty));
                } else {
                    highlighted.push(Math.round(defaultColorI + (fullHighlightI - defaultColorI) * certainty));
                }
            }
            highlighted.push(1.0);
            return highlighted;

        }

        function update() {
            if (!initiated) {
                wait_init();
            } else if (!engaged) {
                wait_engage();
            } else {
                wait_aware();
            }
        }

        function wait_engage() {
            $.getJSON($SCRIPT_ROOT + '/initloop',
            function (data) {
                if (parseInt(data) == 2) {
                    $('#graphs').show();
                    engaged = 1;
                }
            });
        }

        {# define looping function for epistemic initialization #}
        function wait_init() {
            $.getJSON($SCRIPT_ROOT + '/initloop',
            function (data) {
                initiated = parseInt(data);
                if (initiated) {
                    {# when initialized, reload page and flip the loop fn #}
                    {# hack job to force reload just once #}
                    var url = window.location.href;
                    if (url.indexOf('?') < 1) {
                        if(url.indexOf('init') < 0){
                            url = url + "?init=true";
                            window.location = url;
                        }
                    }
                }
            })
        }

        {# define looping function for epistemic update #}
        function wait_aware() {
            $.getJSON($SCRIPT_ROOT + '/awareloop',
            function (data) {
                {# feed "0" when diana says "bye", then reload page and flip the loop fn #}
                if (parseInt(data) === 0) {
                    engaged = 0;
                    $('#graphs').hide();
                    return;
                }
                let id;
                let splitted;
                for (const i in data.c) {
                    splitted = data.c[i].split("::");
                    id = splitted[0];
                    var certainty = parseFloat(splitted[1]);
                    var object = $('#C' + id);
                    object.css('background', 'rgba(' + getCertaintyColor(certainty) + ')');
                }
                for (const j in data.r) {
                    splitted = data.r[j].split("::");
                    id = splitted[0];
                    certainty = parseFloat(splitted[1]);
                    object = $('#R' + id);
                    object.css('stroke', 'rgba(' + getCertaintyColor(certainty) + ')');
                    object.css('strokewidth', certainty * 2 + 3.0);
                }
            })
        }

        {# run the looping function once the document is fully loaded #}
        $(document).ready(function () {
            setInterval(update, 100);
        });

        function force_refresh() {
            initiated = 0;
            engaged = 0;
            $('#graphs').innerHTML = '';
            var url = window.location.href;
            if (url.indexOf('?') > -1) {
                url = url.substring(0,url.indexOf('?'))
                window.location = url;
            }
        }
    </script>
    <div id="title" style="
            width:100%;
            height:100px;
            left:0px;
            top:0px;
            background:rgba(0,0,0,0);
            position:fixed;"
         title="EpiSim">
        <button type="button" onclick="force_refresh()">Reset!</button>
        <h1 align="center">EpiSim</h1>
        <h2 align="center">Visualizing the Agent's epistemic state about current user</h2>
    </div>
    <div id="graphs">
        {{ concept_divs|safe }}
        {{ relation_svg|safe }}
        {{ property_boxes|safe }}
    </div>
</body>
